<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot - 츼reas Protegidas de Belice</title>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-leaf"></i> Informaci칩n geoespacial para el cumplimiento del Reglamento Europeo sobre Productos Libres de Deforestaci칩n (EUDR)</h1>
            <p>Consulta informaci칩n sobre restricciones, geoprocesos y regulaciones ambientales</p>
        </div>
        <div class="chat-container" id="chat-container">
            <div class="message bot-message">
                <div class="message-wrapper">
                    <div class="bot-avatar">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <div>
                        <div class="message-content">
                            춰Hola! 游 Soy tu asistente especializado en 치reas protegidas. Puedes preguntarme sobre restricciones, geoprocesos o cualquier aspecto relacionado con los datos disponibles. 쮼n qu칠 puedo ayudarte hoy?
                        </div>
                        <div class="timestamp">Hoy, 10:30 AM</div>
                        <div class="suggested-questions" id="initial-questions">
                            <button class="suggested-question">쯈u칠 치reas protegidas existen en Belice?</button>
                            <button class="suggested-question">쮺u치les son las restricciones principales?</button>
                            <button class="suggested-question">쮺칩mo se aplican los geoprocesos?</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="typing-indicator" id="typing-indicator">
            <i class="fas fa-robot"></i> Escribiendo respuesta...
        </div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Escribe tu pregunta aqu칤..." />
            <button id="send-button" aria-label="Enviar mensaje">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div class="footer">
            <i class="fas fa-shield-alt"></i> Asistente de Consultas - 츼reas Protegidas de Belice 춸 2024
        </div>
    </div>

    <script src="db.js"></script>
    <script>
        // Configuraci칩n de la API de Gemini
        const apiKey = '';
        const url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=" + apiKey;
        // Historial de la conversaci칩n
        let historialConversacion = [];

        // Elementos del DOM
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Prevenir zoom en iOS cuando se enfoca el input
        userInput.addEventListener('touchstart', function() {
            userInput.style.fontSize = '16px';
        });

        // A침adir event listeners a las preguntas iniciales
        document.addEventListener('DOMContentLoaded', function() {
            const initialQuestions = document.querySelectorAll('#initial-questions .suggested-question');
            initialQuestions.forEach(question => {
                question.addEventListener('click', function() {
                    userInput.value = this.textContent;
                    sendMessage();
                });
            });
        });

        // Funci칩n para enviar mensajes
        async function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;

            // Deshabilitar bot칩n y input durante el env칤o
            sendButton.disabled = true;
            userInput.disabled = true;

            // Agregar mensaje del usuario al chat
            addMessageToChat('user', message);
            userInput.value = '';

            // Mostrar indicador de escritura
            typingIndicator.classList.add('active');
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Obtener respuesta del bot
            const response = await obtenerRespuesta(message);

            // Ocultar indicador de escritura
            typingIndicator.classList.remove('active');

            // Agregar respuesta del bot al chat
            addMessageToChat('bot', response.respuesta, response.preguntas);

            // Rehabilitar bot칩n y input
            sendButton.disabled = false;
            userInput.disabled = false;
            userInput.focus();
        }

        // Funci칩n para agregar mensajes al chat
        function addMessageToChat(sender, message, preguntas = []) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'bot-message');

            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('message-wrapper');

            // Crear avatar
            const avatar = document.createElement('div');
            avatar.classList.add(sender === 'user' ? 'user-avatar' : 'bot-avatar');
            avatar.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-leaf"></i>';

            // Crear contenido del mensaje
            const messageContent = document.createElement('div');
            messageContent.classList.add('message-content');
            messageContent.innerHTML = formatMessage(message);

            // Crear timestamp
            const timestamp = document.createElement('div');
            timestamp.classList.add('timestamp');
            const now = new Date();
            timestamp.textContent = `Hoy, ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;

            // Estructurar el mensaje
            const messageInfo = document.createElement('div');
            messageInfo.appendChild(messageContent);
            messageInfo.appendChild(timestamp);

            if (sender === 'user') {
                messageWrapper.appendChild(messageInfo);
                messageWrapper.appendChild(avatar);
            } else {
                messageWrapper.appendChild(avatar);
                messageWrapper.appendChild(messageInfo);
                
                // Agregar preguntas sugeridas para respuestas del bot
                if (preguntas.length > 0) {
                    const suggestedQuestions = document.createElement('div');
                    suggestedQuestions.classList.add('suggested-questions');
                    
                    preguntas.forEach(question => {
                        const button = document.createElement('button');
                        button.classList.add('suggested-question');
                        button.textContent = question;
                        button.addEventListener('click', function() {
                            userInput.value = question;
                            sendMessage();
                        });
                        suggestedQuestions.appendChild(button);
                    });
                    
                    messageInfo.appendChild(suggestedQuestions);
                }
            }

            messageDiv.appendChild(messageWrapper);
            chatContainer.appendChild(messageDiv);

            // Scroll al final del chat con animaci칩n suave
            setTimeout(() => {
                chatContainer.scrollTo({
                    top: chatContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        // Funci칩n para formatear mensajes (admite markdown b치sico)
        function formatMessage(message) {
            return message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        // Funci칩n para escapar caracteres especiales en HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Funci칩n para agregar enlaces a la respuesta basada en los datos
        function agregarEnlacesARespuesta(respuesta) {
            if (typeof respuesta !== 'string') return respuesta;
            
            // Filtramos datos que tienen enlace y nombre, y ordenamos por longitud del nombre descendente
            const datosConEnlace = datos.filter(dato => dato.enlace && dato.nombre);
            const datosOrdenados = datosConEnlace.sort((a, b) => b.nombre.length - a.nombre.length);
            
            for (const dato of datosOrdenados) {
                const nombre = dato.nombre;
                // Escapamos el nombre para regex
                const nombreEscapado = nombre.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                // Creamos la regex para buscar el nombre como palabra completa
                const regex = new RegExp(`\\b${nombreEscapado}\\b`, 'gi');
                // Reemplazamos
                respuesta = respuesta.replace(regex, `<a href="${escapeHtml(dato.enlace)}" target="_blank">${escapeHtml(nombre)}</a>`);
            }
            return respuesta;
        }

        // Funci칩n para obtener respuesta de la API de Gemini
        async function obtenerRespuesta(pregunta) {
            // Agregar la pregunta del usuario al historial
            historialConversacion.push({
                role: "user",
                parts: [{ text: pregunta }]
            });

            // Crear el prompt con la base de datos y la pregunta
            const promptBase = `Eres un asistente experto en 치reas protegidas y regulaciones ambientales.
            Tu funci칩n es responder preguntas bas치ndote exclusivamente en la siguiente base de datos:

            ${JSON.stringify(datos)}

            Instrucciones:
            1. Responde de manera clara, concisa y amigable.
            2. Si la informaci칩n para responder la pregunta est치 en la base de datos, 칰sala.
            3. Si la informaci칩n no est치 en la base de datos, indica amablemente que no tienes esa informaci칩n espec칤fica.
            4. Mant칠n un tono profesional pero accesible y usa emojis ocasionalmente.
            5. No inventes informaci칩n que no est칠 en la base de datos.
            6. Puedes hacer referencia a los IDs de restricci칩n o datos cuando sea relevante.
            7. Usa formato de texto enriquecido cuando sea apropiado (**negrita**, *cursiva*).
            8. Cuando menciones un 치rea protegida o dato espec칤fico que tenga un enlace, incluye su nombre exactamente como aparece en la base de datos para que pueda ser identificado como enlace.
            9. Despu칠s de tu respuesta, genera exactamente 3 preguntas de seguimiento que el usuario podr칤a hacer para profundizar en el tema. Estas preguntas deben estar basadas en la conversaci칩n actual y en la informaci칩n proporcionada.

            Formato de respuesta:
            [RESPUESTA]
            ...tu respuesta aqu칤...
            [/RESPUESTA]

            [PREGUNTAS]
            1. Primera pregunta de seguimiento
            2. Segunda pregunta de seguimiento
            3. Tercera pregunta de seguimiento
            [/PREGUNTAS]

            Pregunta del usuario: ${pregunta}`;

            // Preparar contenidos para Gemini
            const contenidos = [
                {
                    role: "user",
                    parts: [{ text: promptBase }]
                }
            ];

            // Agregar historial de conversaci칩n (m치ximo 칰ltimas 10 interacciones)
            const historialReciente = historialConversacion.slice(-10);
            contenidos.push(...historialReciente);

            const requestBody = {
                contents: contenidos,
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 3000, // Aumentado para evitar respuestas cortadas
                }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`Error en la petici칩n: ${response.status} ${response.statusText}`);
                }

                const dataResp = await response.json();

                // Manejo seguro de la respuesta
                if (dataResp?.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const respuestaCompleta = dataResp.candidates[0].content.parts[0].text.trim();
                    
                    // Extraer la respuesta principal y las preguntas
                    let respuestaPrincipal = "";
                    let preguntasSeguimiento = [];
                    
                    // Parsear la respuesta - manejo robusto de etiquetas
                    const respuestaMatch = respuestaCompleta.match(/\[RESPUESTA\]([\s\S]*?)\[\/RESPUESTA\]/i);
                    if (respuestaMatch && respuestaMatch[1]) {
                        respuestaPrincipal = respuestaMatch[1].trim();
                    } else {
                        // Si no se encuentra el formato, buscar sin etiqueta de cierre
                        const respuestaSinCierre = respuestaCompleta.match(/\[RESPUESTA\]([\s\S]*?)(?=\[PREGUNTAS\]|$)/i);
                        if (respuestaSinCierre && respuestaSinCierre[1]) {
                            respuestaPrincipal = respuestaSinCierre[1].trim();
                        } else {
                            // Si no se encuentra, quitar cualquier etiqueta y mostrar todo
                            respuestaPrincipal = respuestaCompleta.replace(/\[\/?RESPUESTA\]/gi, '').trim();
                        }
                    }
                    
                    const preguntasMatch = respuestaCompleta.match(/\[PREGUNTAS\]([\s\S]*?)\[\/PREGUNTAS\]/i);
                    if (preguntasMatch && preguntasMatch[1]) {
                        // Extraer las preguntas numeradas
                        const lineas = preguntasMatch[1].split('\n');
                        for (const linea of lineas) {
                            const match = linea.match(/^\d+\.\s*(.+)$/);
                            if (match && match[1]) {
                                preguntasSeguimiento.push(match[1].trim());
                            }
                        }
                        
                        // Si no se extrajeron suficientes preguntas, generar algunas gen칠ricas
                        if (preguntasSeguimiento.length < 3) {
                            const preguntasGenericas = [
                                "쯇uedes darme m치s detalles sobre este tema?",
                                "쮺칩mo se relaciona esto con otras 치reas protegidas?",
                                "Qu칠 implicaciones tiene esto para el cumplimiento del EUDR?"
                            ];
                            
                            while (preguntasSeguimiento.length < 3) {
                                preguntasSeguimiento.push(preguntasGenericas[preguntasSeguimiento.length]);
                            }
                        }
                    } else {
                        // Si no se encuentran preguntas, generar algunas gen칠ricas
                        preguntasSeguimiento = [
                            "쯇uedes darme m치s detalles sobre este tema?",
                            "쮺칩mo se relaciona esto con otras 치reas protegidas?",
                            "Qu칠 implicaciones tiene esto para el cumplimiento del EUDR?"
                        ];
                    }
                    
                    // Agregamos los enlaces a la respuesta principal
                    respuestaPrincipal = agregarEnlacesARespuesta(respuestaPrincipal);
                    
                    // Agregar la respuesta del modelo al historial (solo la respuesta principal)
                    historialConversacion.push({
                        role: "model",
                        parts: [{ text: respuestaPrincipal }]
                    });

                    return {
                        respuesta: respuestaPrincipal,
                        preguntas: preguntasSeguimiento
                    };
                } else {
                    throw new Error("Respuesta inesperada de la API de Gemini");
                }
            } catch (error) {
                console.error("Error al llamar a la API de Gemini:", error);
                return {
                    respuesta: "Lo siento, ocurri칩 un error al procesar tu pregunta. 游땞 Por favor, intenta nuevamente m치s tarde o verifica tu conexi칩n a internet.",
                    preguntas: [
                        "쯈u칠 치reas protegidas existen en Belice?",
                        "쮺u치les son las restricciones principales?",
                        "쮺칩mo se aplican los geoprocesos?"
                    ]
                };
            }
        }

        // Funci칩n para limpiar el historial
        function limpiarHistorial() {
            historialConversacion = [];
            localStorage.removeItem('chatHistory');
        }

        // Auto-focus en el input al cargar la p치gina
        window.addEventListener('load', () => {
            userInput.focus();
        });

        // Manejar cambios de orientaci칩n en dispositivos m칩viles
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 300);
        });
    </script>
</body>
</html>