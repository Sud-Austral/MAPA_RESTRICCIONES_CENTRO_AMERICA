<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot - √Åreas Protegidas de Belice</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== VARIABLES CSS ===== */
        :root {
            --primary-color: #1e88e5;
            --primary-dark: #1565c0;
            --primary-light: #64b5f6;
            --secondary-color: #43a047;
            --accent-color: #ff7043;
            --background: #f5f7fa;
            --surface: #ffffff;
            --text-primary: #212121;
            --text-secondary: #757575;
            --divider: #e0e0e0;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 5px 15px rgba(0, 0, 0, 0.2);
            --radius: 12px;
            --font-size-base: 16px;
        }

        /* ===== ESTILOS GENERALES ===== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            line-height: 1.5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            position: relative;
            overflow-x: hidden;
            font-size: var(--font-size-base);
        }

        /* Fondo animado */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><pattern id="leaf" patternUnits="userSpaceOnUse" width="100" height="100"><g fill="rgba(255,255,255,0.1)"><path d="M50 10c20 0 30 15 30 40-5-20-15-30-30-30s-25 10-30 30c0-25 10-40 30-40z"/></g></pattern></defs><rect width="100%" height="100%" fill="url(%23leaf)"/></svg>') repeat;
            opacity: 0.1;
            z-index: -1;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        /* ===== CONTENEDOR PRINCIPAL ===== */
        .container {
            width: 100vw;
            height: 100vh;
            max-width: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: none;
            border: none;
            position: relative;
            animation: slideInUp 0.6s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== CABECERA ===== */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 14px;
            opacity: 0.95;
            margin-top: 5px;
            position: relative;
            z-index: 2;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
        }

        /* ===== CONTENEDOR DE CHAT ===== */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
            font-size: var(--font-size-base);
        }

        /* ===== MENSAJES ===== */
        .message {
            display: flex;
            margin-bottom: 5px;
            animation: fadeInUp 0.4s ease-out;
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .user-message {
            justify-content: flex-end;
        }

        .bot-message {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 75%;
            padding: 15px 20px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            font-size: var(--font-size-base);
            line-height: 1.4;
            letter-spacing: 0.2px;
        }

        .message-content:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.15);
        }

        .user-message .message-content {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border-bottom-right-radius: 5px;
            position: relative;
        }

        .user-message .message-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent);
            border-radius: inherit;
            pointer-events: none;
        }

        .bot-message .message-content {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            color: var(--text-primary);
            border: 1px solid rgba(30, 136, 229, 0.1);
            border-bottom-left-radius: 5px;
        }

        /* ===== AVATARES ===== */
        .bot-avatar, .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .bot-avatar {
            background: linear-gradient(135deg, var(--secondary-color), #2e7d32);
            margin-right: 10px;
        }

        .user-avatar {
            background: linear-gradient(135deg, var(--accent-color), #e64a19);
            margin-left: 10px;
        }

        .bot-avatar:hover, .user-avatar:hover {
            transform: scale(1.1);
        }

        .bot-avatar i, .user-avatar i {
            font-size: 16px;
        }

        .message-wrapper {
            display: flex;
            align-items: flex-end;
            max-width: 85%;
        }

        .bot-message .message-wrapper {
            flex-direction: row;
        }

        .user-message .message-wrapper {
            flex-direction: row-reverse;
            margin-left: auto;
        }

        /* ===== TIMESTAMP ===== */
        .timestamp {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 5px;
            text-align: right;
            opacity: 0.7;
        }

        .bot-message .timestamp {
            text-align: left;
        }

        /* ===== INDICADOR DE ESCRITURA ===== */
        .typing-indicator {
            display: none;
            padding: 8px 15px;
            color: var(--text-secondary);
            font-style: italic;
            font-size: 13px;
            animation: pulse 1.5s infinite;
            text-align: center;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .typing-indicator.active {
            display: block;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--primary-color);
            margin: 0 2px;
            animation: typing-bounce 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing-bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        /* ===== INDICADOR DE CARGA ===== */
        .loading-indicator {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .loading-indicator.active {
            display: flex;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(30, 136, 229, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== ENTRADA DE USUARIO ===== */
        .input-container {
            display: flex;
            padding: 12px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--divider);
            gap: 10px;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        #user-input {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid var(--divider);
            border-radius: 25px;
            outline: none;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
        }

        #user-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
            transform: translateY(-1px);
        }

        #user-input::placeholder {
            color: #aaa;
            font-style: italic;
        }

        /* ===== BOTONES ===== */
        #send-button {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(30, 136, 229, 0.3);
        }

        #send-button:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 6px 16px rgba(30, 136, 229, 0.4);
        }

        #send-button:active {
            transform: scale(0.95);
        }

        #send-button i {
            transition: transform 0.3s ease;
        }

        #send-button:hover i {
            transform: rotate(15deg);
        }

        #send-button.rotating {
            animation: rotate 1.5s linear infinite;
            background: linear-gradient(135deg, var(--secondary-color), #2e7d32);
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #clear-button {
            background: linear-gradient(135deg, var(--accent-color), #e64a19);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 112, 67, 0.3);
            margin-left: 5px;
        }

        #clear-button:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 112, 67, 0.4);
        }

        #clear-button:active {
            transform: scale(0.95);
        }

        #export-button {
            background: linear-gradient(135deg, var(--secondary-color), #2e7d32);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(67, 160, 71, 0.3);
            margin-left: 5px;
        }

        #export-button:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 6px 16px rgba(67, 160, 71, 0.4);
        }

        #export-button:active {
            transform: scale(0.95);
        }

        #dark-mode-toggle {
            background: linear-gradient(135deg, #424242, #212121);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(66, 66, 66, 0.3);
            margin-left: 5px;
        }

        #dark-mode-toggle:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 6px 16px rgba(66, 66, 66, 0.4);
        }

        #dark-mode-toggle:active {
            transform: scale(0.95);
        }

        /* ===== PREGUNTAS SUGERIDAS ===== */
        .suggested-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            margin-left: 46px;
        }

        .suggested-question {
            background: rgba(30, 136, 229, 0.1);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 6px 12px;
            border-radius: 18px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            outline: none;
            text-align: center;
            flex: 1 1 calc(33% - 8px);
            min-width: 140px;
        }

        .suggested-question:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(30, 136, 229, 0.2);
        }

        .suggested-question:active {
            transform: scale(0.95);
        }

        /* ===== FOOTER ===== */
        .footer {
            padding: 10px 15px;
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--divider);
        }

        /* ===== SCROLLBAR ===== */
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        }

        /* ===== EFECTOS DE ESCRITURA ===== */
        .typing-cursor {
            display: inline-block;
            width: 3px;
            height: 18px;
            background-color: var(--primary-color);
            animation: blink 1s infinite;
            vertical-align: text-bottom;
            margin-left: 2px;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .bot-avatar.typing {
            animation: pulse-avatar 1.5s infinite;
        }
        
        @keyframes pulse-avatar {
            0% { box-shadow: 0 0 0 0 rgba(67, 160, 71, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(67, 160, 71, 0); }
            100% { box-shadow: 0 0 0 0 rgba(67, 160, 71, 0); }
        }

        /* ===== ENLACES ===== */
        .bot-message .message-content a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 1px dotted transparent;
        }

        .bot-message .message-content a:hover {
            color: var(--primary-dark);
            border-bottom-color: var(--primary-dark);
        }

        /* ===== BOT√ìN COPIAR ===== */
        .copy-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0;
            transition: all 0.2s ease;
        }

        .message-content:hover .copy-button {
            opacity: 1;
        }

        .copy-button:hover {
            background: var(--primary-color);
            color: white;
        }

        .copy-button.copied {
            background: var(--secondary-color);
            color: white;
        }

        /* ===== INDICADOR DE CARACTERES ===== */
        .char-counter {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 5px;
            margin-right: 10px;
        }

        /* ===== MODO OSCURO ===== */
        body.dark-mode {
            --background: #1a1a1a;
            --surface: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --divider: #404040;
        }
        
        body.dark-mode .container {
            background: rgba(45, 45, 45, 0.95);
        }
        
        body.dark-mode .chat-container {
            background: linear-gradient(to bottom, #2d2d2d, #1a1a1a);
        }
        
        body.dark-mode .bot-message .message-content {
            background: linear-gradient(135deg, #3d3d3d, #2d2d2d);
            border-color: rgba(30, 136, 229, 0.3);
        }
        
        body.dark-mode .input-container {
            background: rgba(45, 45, 45, 0.9);
        }
        
        body.dark-mode #user-input {
            background: #3d3d3d;
            color: white;
            border-color: #555;
        }
        
        body.dark-mode #user-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2);
        }
        
        body.dark-mode .footer {
            background: rgba(45, 45, 45, 0.9);
        }
        
        body.dark-mode .suggested-question {
            background: rgba(30, 136, 229, 0.2);
            border-color: var(--primary-light);
            color: var(--primary-light);
        }
        
        body.dark-mode .suggested-question:hover {
            background: var(--primary-light);
            color: white;
        }
        
        body.dark-mode .copy-button {
            background: rgba(255, 255, 255, 0.2);
            color: #b0b0b0;
        }
        
        body.dark-mode .copy-button:hover {
            background: var(--primary-light);
            color: white;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                height: 100vh;
                max-height: none;
                border-radius: 0;
                max-width: none;
            }
            
            .header {
                padding: 12px 8px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .header p {
                font-size: 12px;
            }
            
            .chat-container {
                padding: 10px;
            }
            
            .message-content {
                max-width: 85%;
                padding: 12px 15px;
                font-size: 15px;
            }
            
            .bot-avatar, .user-avatar {
                width: 32px;
                height: 32px;
            }
            
            .bot-avatar {
                margin-right: 8px;
            }
            
            .user-avatar {
                margin-left: 8px;
            }
            
            .input-container {
                padding: 10px 8px;
            }
            
            #user-input {
                padding: 10px 15px;
                font-size: 15px;
            }
            
            #send-button, #clear-button, #export-button, #dark-mode-toggle {
                width: 40px;
                height: 40px;
            }
            
            .suggested-questions {
                margin-left: 40px;
                flex-direction: column;
            }
            
            .suggested-question {
                flex: 1 1 100%;
                min-width: auto;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 16px;
            }
            
            .header p {
                font-size: 11px;
            }
            
            .message-content {
                max-width: 90%;
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .bot-avatar, .user-avatar {
                width: 28px;
                height: 28px;
            }
            
            #user-input {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            #send-button, #clear-button, #export-button, #dark-mode-toggle {
                width: 38px;
                height: 38px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 700px;
                height: 80vh;
            }
            
            .message-content {
                max-width: 70%;
                font-size: 15px;
            }
        }

        @media (min-width: 1200px) {
            .container {
                max-width: 1000px;
            }
            
            .message-content {
                font-size: 17px;
            }
        }

        @media (max-height: 500px) and (orientation: landscape) {
            .container {
                height: 95vh;
            }
            
            .header {
                padding: 8px;
            }
            
            .header h1 {
                font-size: 16px;
            }
            
            .header p {
                display: none;
            }
            
            .chat-container {
                padding: 8px;
            }
        }

        /* ===== ACCESIBILIDAD ===== */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-leaf"></i> Informaci√≥n geoespacial para el cumplimiento del Reglamento Europeo sobre Productos Libres de Deforestaci√≥n (EUDR)</h1>
            <p>Consulta informaci√≥n sobre restricciones, geoprocesos y regulaciones ambientales</p>
        </div>
        <div class="chat-container" id="chat-container">
            <div class="message bot-message">
                <div class="message-wrapper">
                    <div class="bot-avatar">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <div>
                        <div class="message-content">
                            ¬°Hola! üåø Soy tu asistente especializado en √°reas protegidas. Puedes preguntarme sobre restricciones, geoprocesos o cualquier aspecto relacionado con los datos disponibles. ¬øEn qu√© puedo ayudarte hoy?
                        </div>
                        <div class="timestamp">Hoy, 10:30 AM</div>
                        <div class="suggested-questions" id="initial-questions">
                            <button class="suggested-question">¬øQu√© √°reas protegidas existen en Belice?</button>
                            <button class="suggested-question">¬øCu√°les son las restricciones principales?</button>
                            <button class="suggested-question">¬øC√≥mo se aplican los geoprocesos?</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="typing-indicator" id="typing-indicator">
            <i class="fas fa-robot"></i> El asistente est√° escribiendo<span>.</span><span>.</span><span>.</span>
        </div>
        <div class="loading-indicator" id="loading-indicator">
            <div class="loading-spinner"></div>
            <p>Procesando tu solicitud...</p>
        </div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Escribe tu pregunta aqu√≠..." aria-label="Escribe tu pregunta aqu√≠" />
            <div class="char-counter" id="char-counter">0/500</div>
            <button id="send-button" aria-label="Enviar mensaje">
                <i class="fas fa-paper-plane"></i>
            </button>
            <button id="clear-button" aria-label="Limpiar chat">
                <i class="fas fa-trash"></i>
            </button>
            <button id="export-button" aria-label="Exportar conversaci√≥n">
                <i class="fas fa-download"></i>
            </button>
            <button id="dark-mode-toggle" aria-label="Cambiar modo oscuro">
                <i class="fas fa-moon"></i>
            </button>
        </div>
        <div class="footer">
            <i class="fas fa-shield-alt"></i> Asistente de Consultas - √Åreas Protegidas de Belice ¬© 2024
        </div>
    </div>
    <script src="db.js"></script>
    <script src="pass.js"></script>

    <script>
        /**
         * CONFIGURACI√ìN DE LA APLICACI√ìN
         * 
         * En un entorno de producci√≥n, las claves de API deben almacenarse en variables de entorno
         * o en un servidor backend, nunca en el c√≥digo del cliente.
         * 
         * Para desarrollo local, puedes usar un archivo .env con variables de entorno.
         */

        // Configuraci√≥n de la API
        //const API_URL = "https://open.bigmodel.cn/api/paas/v4/chat/completions";
        //const API_KEY =  API_KEY; // Reemplazar con tu API key real
        
        // Configuraci√≥n del chatbot
        const MAX_HISTORY_LENGTH = 10; // M√°ximo de mensajes en el historial
        const MAX_INPUT_LENGTH = 500; // M√°ximo de caracteres en el input
        const TYPING_SPEED = 30; // Velocidad de escritura en milisegundos
        const DEBOUNCE_DELAY = 500; // Retraso para el debounce en milisegundos

        
        // Estado de la aplicaci√≥n
        let historialConversacion = [];
        let debounceTimer = null;
        let darkMode = false;

        // Elementos del DOM
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const clearButton = document.getElementById('clear-button');
        const exportButton = document.getElementById('export-button');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const typingIndicator = document.getElementById('typing-indicator');
        const loadingIndicator = document.getElementById('loading-indicator');
        const charCounter = document.getElementById('char-counter');

        // Inicializaci√≥n de la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            // Configurar event listeners
            sendButton.addEventListener('click', sendMessage);
            clearButton.addEventListener('click', clearChat);
            exportButton.addEventListener('click', exportConversation);
            darkModeToggle.addEventListener('click', toggleDarkMode);
            
            // Event listeners para el input
            userInput.addEventListener('keypress', handleKeyPress);
            userInput.addEventListener('input', handleInput);
            userInput.addEventListener('touchstart', preventZoom);
            
            // Configurar preguntas iniciales
            setupInitialQuestions();
            
            // Cargar estado guardado
            loadAppState();
            
            // Enfocar el input
            userInput.focus();
            
            // Configurar atajos de teclado
            setupKeyboardShortcuts();
            
            // Manejar cambios de orientaci√≥n
            window.addEventListener('orientationchange', handleOrientationChange);
        });

        /**
         * Configura las preguntas iniciales sugeridas
         */
        function setupInitialQuestions() {
            const initialQuestions = document.querySelectorAll('#initial-questions .suggested-question');
            initialQuestions.forEach(question => {
                question.addEventListener('click', () => {
                    userInput.value = question.textContent;
                    updateCharCounter();
                    sendMessage();
                });
            });
        }

        /**
         * Maneja el evento de presionar una tecla en el input
         * @param {KeyboardEvent} e - Evento de teclado
         */
        function handleKeyPress(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        }

        /**
         * Maneja el evento de entrada en el input de texto
         */
        function handleInput() {
            updateCharCounter();
            
            // Implementar debounce para optimizar rendimiento
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                // Aqu√≠ podr√≠as implementar autocompletado o sugerencias en tiempo real
            }, DEBOUNCE_DELAY);
        }

        /**
         * Previene el zoom en iOS cuando se enfoca el input
         */
        function preventZoom() {
            userInput.style.fontSize = '16px';
        }

        /**
         * Actualiza el contador de caracteres
         */
        function updateCharCounter() {
            const currentLength = userInput.value.length;
            charCounter.textContent = `${currentLength}/${MAX_INPUT_LENGTH}`;
            
            // Cambiar color si se acerca al l√≠mite
            if (currentLength > MAX_INPUT_LENGTH * 0.9) {
                charCounter.style.color = 'var(--accent-color)';
            } else {
                charCounter.style.color = 'var(--text-secondary)';
            }
        }

        /**
         * Env√≠a un mensaje del usuario
         */
        async function sendMessage() {
            const message = userInput.value.trim();
            
            // Validar entrada
            if (message === '') {
                showNotification('Por favor, escribe una pregunta antes de enviar.', 'warning');
                return;
            }
            
            if (message.length > MAX_INPUT_LENGTH) {
                showNotification(`Tu mensaje es demasiado largo. M√°ximo ${MAX_INPUT_LENGTH} caracteres.`, 'error');
                return;
            }
            
            // Deshabilitar elementos durante el env√≠o
            setSendingState(true);
            
            // Agregar mensaje del usuario al chat
            addMessageToChat('user', message);
            userInput.value = '';
            updateCharCounter();
            
            // Mostrar indicador de carga
            loadingIndicator.classList.add('active');
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            try {
                // Obtener respuesta del bot
                const response = await obtenerRespuesta(message);
                
                // Ocultar indicador de carga
                loadingIndicator.classList.remove('active');
                
                // Agregar respuesta del bot al chat
                addMessageToChat('bot', response.respuesta, response.preguntas, true);
                
                // Guardar estado de la aplicaci√≥n
                saveAppState();
            } catch (error) {
                console.error("Error al enviar mensaje:", error);
                loadingIndicator.classList.remove('active');
                showNotification('Error al procesar tu solicitud. Por favor, intenta nuevamente.', 'error');
            } finally {
                // Rehabilitar elementos
                setSendingState(false);
                userInput.focus();
            }
        }

        /**
         * Establece el estado de env√≠o (deshabilita/habilita elementos)
         * @param {boolean} isSending - Indica si se est√° enviando un mensaje
         */
        function setSendingState(isSending) {
            sendButton.disabled = isSending;
            userInput.disabled = isSending;
            
            if (isSending) {
                sendButton.classList.add('rotating');
            } else {
                sendButton.classList.remove('rotating');
            }
        }

        /**
         * Agrega un mensaje al chat
         * @param {string} sender - Remitente del mensaje ('user' o 'bot')
         * @param {string} message - Contenido del mensaje
         * @param {Array} preguntas - Preguntas sugeridas (opcional)
         * @param {boolean} typewriterEffect - Si se aplica efecto de escritura
         */
        function addMessageToChat(sender, message, preguntas = [], typewriterEffect = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'bot-message');

            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('message-wrapper');

            // Crear avatar
            const avatar = document.createElement('div');
            avatar.classList.add(sender === 'user' ? 'user-avatar' : 'bot-avatar');
            avatar.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-leaf"></i>';
            
            // Si es un mensaje del bot con efecto de escritura, a√±adir clase de animaci√≥n
            if (sender === 'bot' && typewriterEffect) {
                avatar.classList.add('typing');
            }

            // Crear contenido del mensaje
            const messageContent = document.createElement('div');
            messageContent.classList.add('message-content');
            
            // Si es un mensaje del bot con efecto de escritura, a√±adir cursor inicialmente
            if (sender === 'bot' && typewriterEffect) {
                messageContent.innerHTML = '<span class="typing-cursor"></span>';
            } else {
                messageContent.innerHTML = formatMessage(message);
            }
            
            // A√±adir bot√≥n de copiar para mensajes del bot
            if (sender === 'bot') {
                const copyButton = document.createElement('button');
                copyButton.classList.add('copy-button');
                copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                copyButton.addEventListener('click', () => copyToClipboard(message, copyButton));
                messageContent.appendChild(copyButton);
            }

            // Crear timestamp
            const timestamp = document.createElement('div');
            timestamp.classList.add('timestamp');
            const now = new Date();
            timestamp.textContent = `Hoy, ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;

            // Estructurar el mensaje
            const messageInfo = document.createElement('div');
            messageInfo.appendChild(messageContent);
            messageInfo.appendChild(timestamp);

            if (sender === 'user') {
                messageWrapper.appendChild(messageInfo);
                messageWrapper.appendChild(avatar);
            } else {
                messageWrapper.appendChild(avatar);
                messageWrapper.appendChild(messageInfo);
                
                // Agregar preguntas sugeridas para respuestas del bot
                if (preguntas.length > 0) {
                    const suggestedQuestions = document.createElement('div');
                    suggestedQuestions.classList.add('suggested-questions');
                    suggestedQuestions.style.display = 'none'; // Ocultar inicialmente
                    
                    preguntas.forEach(question => {
                        const button = document.createElement('button');
                        button.classList.add('suggested-question');
                        button.textContent = question;
                        button.addEventListener('click', () => {
                            userInput.value = question;
                            updateCharCounter();
                            sendMessage();
                        });
                        suggestedQuestions.appendChild(button);
                    });
                    
                    messageInfo.appendChild(suggestedQuestions);
                }
            }

            messageDiv.appendChild(messageWrapper);
            chatContainer.appendChild(messageDiv);

            // Scroll al final del chat con animaci√≥n suave
            setTimeout(() => {
                chatContainer.scrollTo({
                    top: chatContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
            
            // Si es un mensaje del bot con efecto de escritura, iniciar la animaci√≥n
            if (sender === 'bot' && typewriterEffect) {
                typeWriter(messageContent, message, 0, TYPING_SPEED, () => {
                    // Mostrar las preguntas sugeridas despu√©s de completar la escritura
                    if (preguntas.length > 0) {
                        const suggestedQuestions = messageInfo.querySelector('.suggested-questions');
                        if (suggestedQuestions) {
                            suggestedQuestions.style.display = 'flex';
                        }
                    }
                    // Quitar la clase de animaci√≥n del avatar
                    avatar.classList.remove('typing');
                });
            }
        }

        /**
         * Implementa el efecto de escritura progresiva
         * @param {HTMLElement} element - Elemento donde se escribir√° el texto
         * @param {string} text - Texto a escribir
         * @param {number} index - √çndice actual
         * @param {number} speed - Velocidad de escritura
         * @param {Function} callback - Funci√≥n a ejecutar al finalizar
         */
        function typeWriter(element, text, index, speed, callback) {
            if (index < text.length) {
                // Obtener el contenido actual sin el cursor
                const currentContent = element.innerHTML.replace('<span class="typing-cursor"></span>', '');
                
                // A√±adir el siguiente car√°cter
                element.innerHTML = currentContent + text.charAt(index) + '<span class="typing-cursor"></span>';
                
                // Scroll suave hacia abajo mientras se escribe
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Continuar con el siguiente car√°cter
                setTimeout(() => {
                    typeWriter(element, text, index + 1, speed, callback);
                }, speed);
            } else {
                // Eliminar el cursor al finalizar
                const cursor = element.querySelector('.span.typing-cursor');
                if (cursor) {
                    cursor.remove();
                }
                
                // Ejecutar callback si existe
                if (callback) callback();
            }
        }

        /**
         * Formatea un mensaje con Markdown b√°sico
         * @param {string} message - Mensaje a formatear
         * @returns {string} Mensaje formateado
         */
        function formatMessage(message) {
            return message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        /**
         * Escapa caracteres especiales en HTML
         * @param {string} text - Texto a escapar
         * @returns {string} Texto escapado
         */
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        /**
         * Agrega enlaces a la respuesta basada en los datos
         * @param {string} respuesta - Respuesta a procesar
         * @returns {string} Respuesta con enlaces agregados
         */
        function agregarEnlacesARespuesta(respuesta) {
            if (typeof respuesta !== 'string') return respuesta;
            
            // Filtramos datos que tienen enlace y nombre, y ordenamos por longitud del nombre descendente
            const datosConEnlace = datos.filter(dato => dato.enlace && dato.nombre);
            const datosOrdenados = datosConEnlace.sort((a, b) => b.nombre.length - a.nombre.length);
            
            for (const dato of datosOrdenados) {
                const nombre = dato.nombre;
                // Escapamos el nombre para regex
                const nombreEscapado = nombre.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                // Creamos la regex para buscar el nombre como palabra completa
                const regex = new RegExp(`\\b${nombreEscapado}\\b`, 'gi');
                // Reemplazamos
                respuesta = respuesta.replace(regex, `<a href="${escapeHtml(dato.enlace)}" target="_blank">${escapeHtml(nombre)}</a>`);
            }
            return respuesta;
        }

        /**
         * Obtiene una respuesta de la API de Gemini
         * @param {string} pregunta - Pregunta del usuario
         * @returns {Promise<Object>} Respuesta del bot
         */
        async function obtenerRespuesta(pregunta) {
            // Sanitizar la entrada del usuario
            const preguntaSanitizada = sanitizeInput(pregunta);
            
            // Agregar la pregunta del usuario al historial
            historialConversacion.push({
                role: "user",
                content: preguntaSanitizada
            });

            // Crear el prompt con la base de datos y la pregunta
            const promptBase = `Eres un asistente experto en el Reglamento Europeo sobre Productos Libres de Deforestaci√≥n.
            El Reglamento Europeo sobre Productos Libres de Deforestaci√≥n (tambi√©n conocido como Reglamento de Deforestaci√≥n Importada) es una normativa de la Uni√≥n Europea dise√±ada para reducir la contribuci√≥n de los productos importados a la deforestaci√≥n y la degradaci√≥n forestal en el mundo. Su objetivo principal es asegurar que los productos que se venden en la UE no provengan de tierras deforestadas ilegalmente o recientemente.
            Aqu√≠ te explico los puntos clave:
            1. Objetivo
            Garantizar que los productos comercializados en la UE no provengan de bosques talados ilegalmente o de tierras deforestadas despu√©s de una fecha l√≠mite espec√≠fica.
            Contribuir a la lucha contra el cambio clim√°tico y la p√©rdida de biodiversidad.
            2. Productos cubiertos
            El reglamento se aplica a productos de alto riesgo de deforestaci√≥n, entre los que se incluyen:
            Aceite de palma
            Soja
            Carne de res
            Madera y productos de madera
            Caf√©
            Cacao
            Caucho
            Productos derivados como chocolate, muebles, cuero, y algunos productos de papel
            3. Obligaciones para los operadores
            Los importadores y comerciantes que venden estos productos en la UE deben diligenciar y demostrar que sus productos son "libres de deforestaci√≥n".
            Deben proporcionar informaci√≥n geogr√°fica sobre el origen de los productos y garantizar que se han producido legalmente y no contribuyen a la deforestaci√≥n reciente.
            4. Sistema de control
            Los operadores deben usar un sistema de diligencia debida que incluye:
            Informaci√≥n sobre la ubicaci√≥n exacta de la producci√≥n.
            Evaluaci√≥n de riesgos de deforestaci√≥n.
            Medidas para mitigar cualquier riesgo identificado.
            La autoridad de cada pa√≠s de la UE puede auditar y sancionar en caso de incumplimiento.
            5. Fecha de entrada en vigor
            El reglamento fue adoptado en 2023 y est√° previsto que su aplicaci√≥n completa comience en 2024, con etapas de implementaci√≥n progresivas.
            6. Impacto esperado
            Incentivar pr√°cticas agr√≠colas y forestales sostenibles.
            Reducir la presi√≥n sobre los bosques tropicales y ecosistemas fr√°giles.
            Aumentar la transparencia en las cadenas de suministro globales.
            Tu funci√≥n es responder preguntas bas√°ndote exclusivamente en la siguiente base de datos:

            ${JSON.stringify(datos)}

            Instrucciones:
            1. Responde de manera clara, concisa y amigable.
            2. Si la informaci√≥n para responder la pregunta est√° en la base de datos, √∫sala. Tambi√©n puedes usar informaci√≥n del prompt inicial.
            3. Si la informaci√≥n no est√° en la base de datos, indica amablemente que no tienes esa informaci√≥n espec√≠fica.
            4. Mant√©n un tono profesional pero accesible y usa emojis ocasionalmente.
            5. No inventes informaci√≥n que no est√© en la base de datos.
            6. Puedes hacer referencia a los IDs de restricci√≥n o datos cuando sea relevante.
            7. Usa formato de texto enriquecido cuando sea apropiado (**negrita**, *cursiva*).
            8. Cuando menciones un √°rea protegida o dato espec√≠fico que tenga un enlace, incluye su nombre exactamente como aparece en la base de datos para que pueda ser identificado como enlace.
            9. Despu√©s de tu respuesta, genera exactamente 3 preguntas de seguimiento que el usuario podr√≠a hacer para profundizar en el tema. Estas preguntas deben estar basadas en la conversaci√≥n actual y en la informaci√≥n proporcionada.
            10. Si la pregunta del usuario es ambigua, poco clara o puede interpretarse de varias maneras, pide amablemente que la aclare antes de responder. Usa frases como "¬øPodr√≠as especificar a qu√© te refieres con‚Ä¶?" o "Para responder con precisi√≥n, necesito un poco m√°s de detalle sobre‚Ä¶".
            11. Evita adivinar la intenci√≥n del usuario cuando la pregunta no est√© clara; siempre solicita la aclaraci√≥n necesaria antes de dar informaci√≥n.

            Formato de respuesta:
            [RESPUESTA]
            ...tu respuesta aqu√≠...
            [/RESPUESTA]

            [PREGUNTAS]
            1. Primera pregunta de seguimiento
            2. Segunda pregunta de seguimiento
            3. Tercera pregunta de seguimiento
            [/PREGUNTAS]

            Pregunta del usuario: ${preguntaSanitizada}`;

            // Preparar mensajes con el historial (m√°ximo √∫ltimas MAX_HISTORY_LENGTH interacciones)
            const historialReciente = historialConversacion.slice(-MAX_HISTORY_LENGTH);
            const mensajes = [
                {
                    role: "user",
                    content: promptBase
                },
                ...historialReciente
            ];

            const requestBody = {
                model: "glm-4.5-flash",
                messages: mensajes,
                temperature: 0.7,
                max_tokens: 3000
            };

            try {
                // Implementar timeout para la llamada a la API
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000000); // 30 segundos
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`Error en la petici√≥n: ${response.status} ${response.statusText}`);
                }

                const dataResp = await response.json();

                // Manejo seguro de la respuesta
                if (dataResp?.choices?.[0]?.message?.content) {
                    const respuestaCompleta = dataResp.choices[0].message.content.trim();
                    
                    // Extraer la respuesta principal y las preguntas
                    let respuestaPrincipal = "";
                    let preguntasSeguimiento = [];
                    
                    // Parsear la respuesta - manejo robusto de etiquetas
                    const respuestaMatch = respuestaCompleta.match(/\[RESPUESTA\]([\s\S]*?)\[\/RESPUESTA\]/i);
                    if (respuestaMatch && respuestaMatch[1]) {
                        respuestaPrincipal = respuestaMatch[1].trim();
                    } else {
                        // Si no se encuentra el formato, buscar sin etiqueta de cierre
                        const respuestaSinCierre = respuestaCompleta.match(/\[RESPUESTA\]([\s\S]*?)(?=\[PREGUNTAS\]|$)/i);
                        if (respuestaSinCierre && respuestaSinCierre[1]) {
                            respuestaPrincipal = respuestaSinCierre[1].trim();
                        } else {
                            // Si no se encuentra, quitar cualquier etiqueta y mostrar todo
                            respuestaPrincipal = respuestaCompleta.replace(/\[\/?RESPUESTA\]/gi, '').trim();
                        }
                    }
                    
                    const preguntasMatch = respuestaCompleta.match(/\[PREGUNTAS\]([\s\S]*?)\[\/PREGUNTAS\]/i);
                    if (preguntasMatch && preguntasMatch[1]) {
                        // Extraer las preguntas numeradas
                        const lineas = preguntasMatch[1].split('\n');
                        for (const linea of lineas) {
                            const match = linea.match(/^\d+\.\s*(.+)$/);
                            if (match && match[1]) {
                                preguntasSeguimiento.push(match[1].trim());
                            }
                        }
                        
                        // Si no se extrajeron suficientes preguntas, generar algunas gen√©ricas
                        if (preguntasSeguimiento.length < 3) {
                            const preguntasGenericas = [
                                "¬øPuedes darme m√°s detalles sobre este tema?",
                                "¬øC√≥mo se relaciona esto con otras √°reas protegidas?",
                                "¬øQu√© implicaciones tiene esto para el cumplimiento del EUDR?"
                            ];
                            
                            while (preguntasSeguimiento.length < 3) {
                                preguntasSeguimiento.push(preguntasGenericas[preguntasSeguimiento.length]);
                            }
                        }
                    } else {
                        // Si no se encuentran preguntas, generar algunas gen√©ricas
                        preguntasSeguimiento = [
                            "¬øPuedes darme m√°s detalles sobre este tema?",
                            "¬øC√≥mo se relaciona esto con otras √°reas protegidas?",
                            "¬øQu√© implicaciones tiene esto para el cumplimiento del EUDR?"
                        ];
                    }
                    
                    // Agregamos los enlaces a la respuesta principal
                    respuestaPrincipal = agregarEnlacesARespuesta(respuestaPrincipal);
                    
                    // Agregar la respuesta del modelo al historial (solo la respuesta principal)
                    historialConversacion.push({
                        role: "assistant",
                        content: respuestaPrincipal
                    });

                    return {
                        respuesta: respuestaPrincipal,
                        preguntas: preguntasSeguimiento
                    };
                } else {
                    throw new Error("Respuesta inesperada de la API");
                }
            } catch (error) {
                console.error("Error al llamar a la API:", error);
                
                // Manejar error de timeout
                if (error.name === 'AbortError') {
                    throw new Error("La solicitud ha excedido el tiempo de espera. Por favor, intenta nuevamente.");
                }
                
                throw error;
            }
        }

        /**
         * Sanitiza la entrada del usuario para prevenir ataques XSS
         * @param {string} input - Entrada del usuario
         * @returns {string} Entrada sanitizada
         */
        function sanitizeInput(input) {
            return input
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                .replace(/javascript:/gi, '')
                .replace(/on\w+\s*=/gi, '');
        }

        /**
         * Limpia el chat
         */
        function clearChat() {
            // Confirmar antes de limpiar
            if (!confirm('¬øEst√°s seguro de que quieres limpiar la conversaci√≥n?')) {
                return;
            }
            
            // Limpiar el contenedor de chat excepto el mensaje inicial
            const messages = chatContainer.querySelectorAll('.message');
            for (let i = 1; i < messages.length; i++) {
                messages[i].remove();
            }
            
            // Limpiar el historial
            historialConversacion = [];
            
            // Limpiar el almacenamiento local
            localStorage.removeItem('chatHistory');
            localStorage.removeItem('darkMode');
            
            // Mostrar notificaci√≥n
            showNotification('Conversaci√≥n limpiada correctamente', 'success');
            
            // Enfocar el input
            userInput.focus();
        }

        /**
         * Exporta la conversaci√≥n a un archivo de texto
         */
        function exportConversation() {
            try {
                // Recopilar todos los mensajes
                const messages = chatContainer.querySelectorAll('.message');
                let conversationText = "Conversaci√≥n con el Asistente de √Åreas Protegidas de Belice\n";
                conversationText += "================================================\n\n";
                
                messages.forEach(message => {
                    const isUser = message.classList.contains('user-message');
                    const messageContent = message.querySelector('.message-content').textContent;
                    const timestamp = message.querySelector('.timestamp').textContent;
                    
                    conversationText += `${isUser ? 'Usuario' : 'Asistente'} (${timestamp}):\n`;
                    conversationText += `${messageContent}\n\n`;
                });
                
                // Crear un blob con el texto
                const blob = new Blob([conversationText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                // Crear un enlace para descargar el archivo
                const a = document.createElement('a');
                a.href = url;
                a.download = `conversacion_areas_protegidas_${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                
                // Limpiar
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // Mostrar notificaci√≥n
                showNotification('Conversaci√≥n exportada correctamente', 'success');
            } catch (error) {
                console.error("Error al exportar la conversaci√≥n:", error);
                showNotification('Error al exportar la conversaci√≥n', 'error');
            }
        }

        /**
         * Alterna el modo oscuro
         */
        function toggleDarkMode() {
            darkMode = !darkMode;
            
            if (darkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.body.classList.remove('dark-mode');
                darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
            
            // Guardar preferencia
            localStorage.setItem('darkMode', darkMode);
        }

        /**
         * Copia el texto al portapapeles
         * @param {string} text - Texto a copiar
         * @param {HTMLElement} button - Bot√≥n que activ√≥ la acci√≥n
         */
        async function copyToClipboard(text, button) {
            try {
                await navigator.clipboard.writeText(text);
                
                // Cambiar el icono del bot√≥n temporalmente
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.add('copied');
                
                // Mostrar notificaci√≥n
                showNotification('Texto copiado al portapapeles', 'success');
                
                // Restaurar el icono despu√©s de 2 segundos
                setTimeout(() => {
                    button.innerHTML = '<i class="fas fa-copy"></i>';
                    button.classList.remove('copied');
                }, 2000);
            } catch (error) {
                console.error("Error al copiar al portapapeles:", error);
                showNotification('Error al copiar al portapapeles', 'error');
            }
        }

        /**
         * Muestra una notificaci√≥n al usuario
         * @param {string} message - Mensaje a mostrar
         * @param {string} type - Tipo de notificaci√≥n ('success', 'error', 'warning', 'info')
         */
        function showNotification(message, type = 'info') {
            // Crear elemento de notificaci√≥n
            const notification = document.createElement('div');
            notification.classList.add('notification');
            notification.classList.add(`notification-${type}`);
            
            // A√±adir icono seg√∫n el tipo
            let icon = '';
            switch (type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
                default:
                    icon = '<i class="fas fa-info-circle"></i>';
            }
            
            notification.innerHTML = `${icon} ${message}`;
            
            // Estilos para la notificaci√≥n
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.padding = '12px 20px';
            notification.style.borderRadius = '8px';
            notification.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            notification.style.zIndex = '1000';
            notification.style.maxWidth = '300px';
            notification.style.animation = 'slideInRight 0.3s ease-out';
            
            // Colores seg√∫n el tipo
            switch (type) {
                case 'success':
                    notification.style.backgroundColor = '#4caf50';
                    notification.style.color = 'white';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#f44336';
                    notification.style.color = 'white';
                    break;
                case 'warning':
                    notification.style.backgroundColor = '#ff9800';
                    notification.style.color = 'white';
                    break;
                default:
                    notification.style.backgroundColor = '#2196f3';
                    notification.style.color = 'white';
            }
            
            // A√±adir al DOM
            document.body.appendChild(notification);
            
            // Eliminar despu√©s de 3 segundos
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        /**
         * Guarda el estado de la aplicaci√≥n en el almacenamiento local
         */
        function saveAppState() {
            try {
                // Guardar historial de conversaci√≥n
                localStorage.setItem('chatHistory', JSON.stringify(historialConversacion));
                
                // Guardar preferencia de modo oscuro
                localStorage.setItem('darkMode', darkMode);
            } catch (error) {
                console.error("Error al guardar el estado de la aplicaci√≥n:", error);
            }
        }

        /**
         * Carga el estado de la aplicaci√≥n desde el almacenamiento local
         */
        function loadAppState() {
            try {
                // Cargar preferencia de modo oscuro
                const savedDarkMode = localStorage.getItem('darkMode');
                if (savedDarkMode !== null) {
                    darkMode = savedDarkMode === 'true';
                    if (darkMode) {
                        document.body.classList.add('dark-mode');
                        darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                    }
                }
                
                // Cargar historial de conversaci√≥n (opcional, deshabilitado por defecto)
                // const savedHistory = localStorage.getItem('chatHistory');
                // if (savedHistory) {
                //     historialConversacion = JSON.parse(savedHistory);
                // }
            } catch (error) {
                console.error("Error al cargar el estado de la aplicaci√≥n:", error);
            }
        }

        /**
         * Configura los atajos de teclado
         */
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + K para limpiar el chat
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    clearChat();
                }
                
                // Ctrl/Cmd + E para exportar la conversaci√≥n
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    exportConversation();
                }
                
                // Ctrl/Cmd + D para alternar modo oscuro
                if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                    e.preventDefault();
                    toggleDarkMode();
                }
            });
        }

        /**
         * Maneja los cambios de orientaci√≥n del dispositivo
         */
        function handleOrientationChange() {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 300);
        }

        // A√±adir estilos para animaciones de notificaciones
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>