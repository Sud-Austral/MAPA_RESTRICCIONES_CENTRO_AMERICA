<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot - Áreas Protegidas de Belice</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background-color: #2c6e49;
            color: white;
            padding: 15px 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        .message {
            margin-bottom: 15px;
            display: flex;
        }
        .user-message {
            justify-content: flex-end;
        }
        .bot-message {
            justify-content: flex-start;
        }
        .message-content {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
        }
        .user-message .message-content {
            background-color: #2c6e49;
            color: white;
        }
        .bot-message .message-content {
            background-color: #e9ecef;
            color: #333;
        }
        .input-container {
            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
        }
        #user-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
        }
        #send-button {
            margin-left: 10px;
            background-color: #2c6e49;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #send-button:hover {
            background-color: #1e4a32;
        }
        .typing-indicator {
            display: none;
            padding: 5px 15px;
            color: #666;
            font-style: italic;
        }
        .typing-indicator.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Asistente de Consultas - Áreas Protegidas de Belice</h1>
        </div>
        <div class="chat-container" id="chat-container">
            <div class="message bot-message">
                <div class="message-content">
                    ¡Hola! Soy un asistente especializado en información sobre áreas protegidas en Belice. Puedes preguntarme sobre restricciones, geoprocesos o cualquier aspecto relacionado con los datos disponibles. ¿En qué puedo ayudarte hoy?
                </div>
            </div>
        </div>
        <div class="typing-indicator" id="typing-indicator">Escribiendo respuesta...</div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Escribe tu pregunta aquí..." />
            <button id="send-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                </svg>
            </button>
        </div>
    </div>
    <script src="db.json"></script>
    <script>
        // Base de datos de áreas protegidas en Belice
        
        // Configuración de la API de Gemini
        const apiKey = 'AIzaSyDLzplCcOl_xbZWghCnwCP9Qmw7cE_eg6o';
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

        // Historial de la conversación
        let historialConversacion = [];

        // Elementos del DOM
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Función para enviar mensajes
        async function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;

            // Agregar mensaje del usuario al chat
            addMessageToChat('user', message);
            userInput.value = '';

            // Mostrar indicador de escritura
            typingIndicator.classList.add('active');

            // Obtener respuesta del bot
            const response = await obtenerRespuesta(message);

            // Ocultar indicador de escritura
            typingIndicator.classList.remove('active');

            // Agregar respuesta del bot al chat
            addMessageToChat('bot', response);
        }

        // Función para agregar mensajes al chat
        function addMessageToChat(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'bot-message');

            const messageContent = document.createElement('div');
            messageContent.classList.add('message-content');
            messageContent.textContent = message;

            messageDiv.appendChild(messageContent);
            chatContainer.appendChild(messageDiv);

            // Scroll al final del chat
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Función para obtener respuesta de la API de Gemini
        async function obtenerRespuesta(pregunta) {
            // Agregar la pregunta del usuario al historial
            historialConversacion.push({
                role: "user",
                parts: [{ text: pregunta }]
            });

            // Crear el prompt con la base de datos y la pregunta
            const promptBase = `Eres un asistente experto en áreas protegidas y regulaciones ambientales en Belice.
            Tu función es responder preguntas basándote exclusivamente en la siguiente base de datos:

            ${JSON.stringify(datos)}

            Instrucciones:
            1. Responde de manera clara y concisa.
            2. Si la información para responder la pregunta está en la base de datos, úsala.
            3. Si la información no está en la base de datos, indica amablemente que no tienes esa información específica.
            4. Mantén un tono profesional pero accesible.
            5. Ofrece preguntas de seguimiento relacionadas con el tema cuando sea apropiado.
            6. No inventes información que no esté en la base de datos.
            7. Puedes hacer referencia a los IDs de restricción o datos cuando sea relevante.

            Pregunta del usuario: ${pregunta}`;

            // Preparar contenidos para Gemini
            const contenidos = [
                {
                    role: "user",
                    parts: [{ text: promptBase }]
                }
            ];

            // Agregar historial de conversación
            contenidos.push(...historialConversacion);

            const requestBody = {
                contents: contenidos
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`Error en la petición: ${response.status} ${response.statusText}`);
                }

                const dataResp = await response.json();

                // Manejo seguro de la respuesta
                if (dataResp?.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const respuesta = dataResp.candidates[0].content.parts[0].text.trim();
                    
                    // Agregar la respuesta del modelo al historial
                    historialConversacion.push({
                        role: "model",
                        parts: [{ text: respuesta }]
                    });

                    return respuesta;
                } else {
                    throw new Error("Respuesta inesperada de la API de Gemini");
                }
            } catch (error) {
                console.error("Error al llamar a la API de Gemini:", error);
                return "Lo siento, ocurrió un error al procesar tu pregunta. Por favor, intenta nuevamente más tarde.";
            }
        }

        // Función para limpiar el historial
        function limpiarHistorial() {
            historialConversacion = [];
        }
    </script>
</body>
</html>